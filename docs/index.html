<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <title>Jadual Tempahan Makmal Komputer SK Sri Aman 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Day.js for dates -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/isoWeek.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/customParseFormat.min.js"></script>
  <script>
    dayjs.extend(dayjs_plugin_isoWeek);
    dayjs.extend(dayjs_plugin_customParseFormat);
  </script>

  <!-- Firebase -->
  <script type="module">
    // -------------------------------
    // CONFIG FIREBASE & INISIALISASI
    // -------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCVpF3NY0v9nZ0VWqPfC34ZHy_T2qHYHQI",
      authDomain: "sksa-ict-asset.firebaseapp.com",
      projectId: "sksa-ict-asset",
      storageBucket: "sksa-ict-asset.appspot.com",
      messagingSenderId: "927810934882",
      appId: "1:927810934882:web:ee490bc8cd0c24a3ee9cce"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const mainDocRef = doc(db, "makmal_komputer", "jadual_2025");

    // ----------------------------------
    // KONFIG HARI & SLOT (PERIOD) / MASA
    // ----------------------------------
    const DAYS = ["Isnin", "Selasa", "Rabu", "Khamis", "Jumaat"];
    const DAY_KEYS = ["mon", "tue", "wed", "thu", "fri"];
    const PERIODS = ["P1", "P2", "P3", "P4", "P5", "P6", "P7"];
    const PERIOD_TIMES = [
      "7.30 - 8.15",
      "8.15 - 9.00",
      "9.00 - 9.45",
      "10.15 - 11.00",
      "11.00 - 11.45",
      "11.45 - 12.30",
      "12.30 - 1.15"
    ];

    const BASE_CLASS = "tempahan-makmal";
    const DATA_VERSION = "v1";

    // ------------------
    // STATE DALAM PAGE
    // ------------------
    let currentSchedule = null;
    let weeklyArchive = [];
    let currentWeekStart = null;
    let archiveViewIndex = -1;
    let isAdminPasswordSet = false;
    let busyModalOpen = false;

    // --------------------------
    // ELEMEN YANG KITA GUNAKAN
    // --------------------------
    window.addEventListener("DOMContentLoaded", () => {
      const weekDisplayEl = document.getElementById("week-display");
      const mainTableBody = document.getElementById("main-table-body");
      const archiveTableBody = document.getElementById("archive-table-body");

      const prevWeekBtn = document.getElementById("prev-week-btn");
      const nextWeekBtn = document.getElementById("next-week-btn");
      const currentWeekBtn = document.getElementById("current-week-btn");

      const loadingOverlay = document.getElementById("loading-overlay");
      const loadingMessage = document.getElementById("loading-message");
      const toastEl = document.getElementById("toast");
      const toastText = document.getElementById("toast-text");

      const adminPanelEl = document.getElementById("admin-panel");
      const adminToggleBtn = document.getElementById("admin-toggle-btn");
      const adminPasswordInput = document.getElementById("admin-password");
      const setAdminPasswordDiv = document.getElementById("set-admin-password");
      const newAdminPasswordInput = document.getElementById("new-admin-password");
      const setAdminPasswordBtn = document.getElementById("set-admin-password-btn");
      const adminLogoutBtn = document.getElementById("admin-logout-btn");

      const resetWeekBtn = document.getElementById("reset-week-btn");
      const manualRolloverBtn = document.getElementById("manual-rollover-btn");
      const exportCsvBtn = document.getElementById("export-csv-btn");
      const exportPrintBtn = document.getElementById("export-print-btn");

      const busyModal = document.getElementById("busy-modal");
      const busyReasonInput = document.getElementById("busy-reason");
      const busyReasonLabel = document.getElementById("busy-reason-label");
      const busyModalTitle = document.getElementById("busy-modal-title");
      const busySlotInfo = document.getElementById("busy-slot-info");
      const busySaveBtn = document.getElementById("busy-save-btn");
      const busyCancelBtn = document.getElementById("busy-cancel-btn");

      const busyCells = document.querySelectorAll(".busy-cell");

      const printTable = document.getElementById("print-table");
      const printBody = document.getElementById("print-table-body");

      const printTitle = document.getElementById("print-title");
      const printWeekText = document.getElementById("print-week-text");
      const printDateTime = document.getElementById("print-date-time");

      let adminLoggedIn = false;
      let selectedSlot = null;

      // -----------------
      // UTILITI & HELPER
      // -----------------
      function showLoading(msg = "Sila tunggu...") {
        loadingMessage.textContent = msg;
        loadingOverlay.classList.remove("hidden");
      }

      function hideLoading() {
        loadingOverlay.classList.add("hidden");
      }

      let toastTimeout = null;
      function showToast(message, isError = false) {
        toastText.textContent = message;
        toastEl.classList.remove("hidden");
        toastEl.classList.remove("bg-green-600", "bg-red-600");
        toastEl.classList.add(isError ? "bg-red-600" : "bg-green-600");

        if (toastTimeout) clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => {
          toastEl.classList.add("hidden");
        }, 3000);
      }

      const storedAdminLogin = localStorage.getItem("jadual_makmal_admin_login_2025");
      if (storedAdminLogin === "true") {
        adminLoggedIn = true;
        updateAdminUI();
      }

      function getDefaultWeekStart() {
        return currentWeekStart || dayjs().isoWeekday(1);
      }

      function formatWeekRange(startDayjs) {
        const start = startDayjs;
        const end = startDayjs.add(4, "day");
        const startStr = start.format("D");
        const endStr = end.format("D MMMM");
        return `${startStr} - ${endStr}`.toUpperCase();
      }

      function getSlotId(dayKey, periodIndex) {
        return `${dayKey}_p${periodIndex + 1}`;
      }

      function parseSlotId(slotId) {
        const [dayKey, pStr] = slotId.split("_");
        const periodIndex = parseInt(pStr.replace("p", "")) - 1;
        return { dayKey, periodIndex };
      }

      function getDisplayedScheduleData() {
        if (archiveViewIndex === -1) {
          return currentSchedule;
        }
        return weeklyArchive[archiveViewIndex]?.schedule || currentSchedule;
      }

      function exportCSV() {
        const data = getDisplayedScheduleData();
        if (!data) {
          showToast("Tiada data untuk dieksport.", true);
          return;
        }
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Hari/Waktu," + PERIOD_TIMES.map(t => `"${t}"`).join(",") + "\r\n";

        DAY_KEYS.forEach((dayKey, dayIndex) => {
          const rowLabel = DAYS[dayIndex];
          const rowData = PERIODS.map((p, pIndex) => {
            const slotId = getSlotId(dayKey, pIndex);
            const assign = data.assignments[slotId] || {};
            const entry = parseBookingText(assign.text);
            const text = entry ? `${entry.tahun} - ${entry.kelas} [${entry.mataPelajaran}] (${entry.namaGuru})` : "";
            return `"${text.replace(/"/g, '""')}"`;
          }).join(",");
          csvContent += `${rowLabel},${rowData}\r\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);

        let startUse = currentWeekStart ? currentWeekStart.format("YYYYMMDD") : "minggu";
        if (archiveViewIndex >= 0) {
          const wItem = weeklyArchive[archiveViewIndex];
          if (wItem?.weekStart) startUse = wItem.weekStart;
        }

        link.setAttribute("download", `Jadual_Makmal_${startUse}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function updateWeekDisplay() {
        const weekStart = (archiveViewIndex === -1)
          ? currentWeekStart || getDefaultWeekStart()
          : (weeklyArchive[archiveViewIndex]?.weekStartDayjs || currentWeekStart || getDefaultWeekStart());

        if (!weekStart) return;

        const labelRange = formatWeekRange(weekStart);
        weekDisplayEl.textContent = `TARIKH: ${labelRange}`;

        if (archiveViewIndex === -1) {
          weekDisplayEl.classList.remove("text-yellow-300");
          weekDisplayEl.classList.remove("bg-yellow-900/40");
          weekDisplayEl.classList.add("text-cyan-200");
        } else {
          weekDisplayEl.classList.remove("text-cyan-200");
          weekDisplayEl.classList.add("text-yellow-300");
          weekDisplayEl.classList.add("bg-yellow-900/40");
        }
      }

      function clearTableBody(tbody) {
        while (tbody.firstChild) {
          tbody.removeChild(tbody.firstChild);
        }
      }

      function getCellBackground(assign) {
        if (!assign || !assign.status || assign.status === "kosong") {
          return "bg-slate-900/60 hover:bg-slate-800/80 cursor-pointer border border-slate-600/80";
        }

        if (assign.status === "tetap") {
          return "bg-green-700/80 hover:bg-green-600/90 border border-emerald-400/70 shadow-[0_0_12px_rgba(16,185,129,0.7)]";
        }

        if (assign.status === "tempahan") {
          return "bg-blue-700/80 hover:bg-blue-600/90 border border-cyan-400/70 shadow-[0_0_12px_rgba(56,189,248,0.7)]";
        }

        if (assign.status === "terkunci") {
          return "bg-slate-700/90 border border-slate-400/70 cursor-not-allowed";
        }

        if (assign.status === "penuh") {
          return "bg-red-700/80 border border-red-500/80 shadow-[0_0_12px_rgba(248,113,113,0.7)] cursor-not-allowed";
        }

        return "bg-slate-900/60 border border-slate-600/80";
      }

      function renderMainTable() {
        const data = currentSchedule;
        if (!data) return;

        clearTableBody(mainTableBody);

        DAY_KEYS.forEach((dayKey, dayIndex) => {
          const row = document.createElement("tr");

          const dayCell = document.createElement("td");
          dayCell.className = "sticky left-0 bg-slate-900/90 backdrop-blur-sm text-cyan-100 font-semibold border border-slate-700/80 px-3 py-2 text-sm sm:text-base align-middle";
          dayCell.textContent = DAYS[dayIndex];
          row.appendChild(dayCell);

          PERIODS.forEach((p, pIndex) => {
            const slotId = getSlotId(dayKey, pIndex);
            const assign = data.assignments[slotId] || { status: "kosong", text: "" };

            const cell = document.createElement("td");
            cell.className = `align-top px-2 py-2 sm:px-3 sm:py-2 text-xs sm:text-sm transition-colors duration-150 ${getCellBackground(assign)}`;
            cell.dataset.slotId = slotId;

            let cellContent = "";

            if (!assign || assign.status === "kosong") {
              cellContent = `<div class="text-slate-300/80 italic text-[11px] sm:text-xs">Tiada tempahan</div>`;
            } else if (assign.status === "terkunci") {
              const reason = (assign.text || "").trim();
              cellContent = `
                <div class="flex flex-col gap-1">
                  <div class="flex items-center justify-between gap-1">
                    <span class="inline-flex items-center gap-1 text-[11px] sm:text-xs font-semibold uppercase tracking-wide text-amber-300">
                      <span class="w-1.5 h-1.5 rounded-full bg-amber-300 animate-pulse"></span>
                      SLOT TERKUNCI
                    </span>
                    <span class="text-[10px] sm:text-[11px] text-amber-200/90 bg-amber-900/50 px-2 py-0.5 rounded-full border border-amber-400/70">
                      Admin
                    </span>
                  </div>
                  <div class="text-[11px] sm:text-xs text-amber-100/90">
                    ${reason || "Digunakan untuk program khas / penyelenggaraan."}
                  </div>
                </div>
              `;
            } else if (assign.status === "penuh") {
              const reason = (assign.text || "").trim();
              cellContent = `
                <div class="flex flex-col gap-1">
                  <div class="flex items-center justify-between gap-1">
                    <span class="inline-flex items-center gap-1 text-[11px] sm:text-xs font-semibold uppercase tracking-wide text-red-100">
                      <span class="w-1.5 h-1.5 rounded-full bg-red-200 animate-ping"></span>
                      SLOT PENUH
                    </span>
                    <span class="text-[10px] sm:text-[11px] text-red-100 bg-red-900/70 px-2 py-0.5 rounded-full border border-red-400/80">
                      Tidak boleh ditempah
                    </span>
                  </div>
                  <div class="text-[11px] sm:text-xs text-red-100/95 leading-snug">
                    ${reason || "Digunakan sepenuhnya untuk aktiviti / pentaksiran / program rasmi."}
                  </div>
                </div>
              `;
            } else {
              const detail = parseBookingText(assign.text);

              if (detail) {
                cellContent = `
                  <div class="flex flex-col gap-1 text-[11px] sm:text-xs text-slate-100">
                    <div class="flex items-center justify-between gap-1">
                      <span class="inline-flex items-center gap-1 text-[10px] sm:text-[11px] font-semibold tracking-wide uppercase ${
                        assign.status === "tetap"
                          ? "text-emerald-200"
                          : "text-cyan-100"
                      }">
                        <span class="w-1.5 h-1.5 rounded-full ${
                          assign.status === "tetap" ? "bg-emerald-300" : "bg-cyan-300"
                        } animate-pulse"></span>
                        ${assign.status === "tetap" ? "Jadual Tetap" : "Tempahan Guru"}
                      </span>
                      <span class="text-[10px] sm:text-[11px] px-2 py-0.5 rounded-full border ${
                        assign.status === "tetap"
                          ? "border-emerald-300 text-emerald-100 bg-emerald-900/50"
                          : "border-cyan-300 text-cyan-100 bg-cyan-900/50"
                      }">
                        ${detail.tahun} - ${detail.kelas}
                      </span>
                    </div>
                    <div class="font-semibold text-[11px] sm:text-xs leading-snug">
                      ${detail.mataPelajaran}
                    </div>
                    <div class="text-[11px] sm:text-[11px] text-slate-100/90">
                      ${detail.namaGuru}
                    </div>
                  </div>
                `;
              } else {
                cellContent = `
                  <div class="text-[11px] sm:text-xs text-slate-100 whitespace-pre-line break-words">
                    ${assign.text || ""}
                  </div>
                `;
              }
            }

            cell.innerHTML = cellContent;

            if (adminLoggedIn) {
              cell.classList.add("cursor-pointer");

              cell.addEventListener("click", () => {
                if (assign.status === "terkunci" || assign.status === "penuh") {
                  showBusyModal(slotId, assign.status, assign.text || "");
                } else {
                  handleAdminCellClick(slotId);
                }
              });
            }

            row.appendChild(cell);
          });

          mainTableBody.appendChild(row);
        });
      }

      function parseBookingText(text) {
        if (!text) return null;
        const lines = text.split("\n").map((l) => l.trim()).filter((l) => l !== "");
        if (lines.length < 2) return null;

        const line1 = lines[0];
        const line2 = lines[1];
        const teacherLine = lines[2] || "";

        const split1 = line1.split("-").map((p) => p.trim());
        if (split1.length < 2) return null;

        const tahunParts = split1[0].split(" ");
        const tahun = tahunParts[tahunParts.length - 1] || "";
        const kelas = split1[1] || "";
        const subjek = line2;
        let namaGuru = teacherLine.replace(/^Guru:\s*/i, "").trim();

        if (!namaGuru) {
          namaGuru = "Guru Tidak Dinyatakan";
        }

        return {
          tahun,
          kelas,
          mataPelajaran: subjek,
          namaGuru,
        };
      }

      function renderArchiveTable() {
        clearTableBody(archiveTableBody);

        if (!weeklyArchive || weeklyArchive.length === 0) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 4;
          cell.className = "px-4 py-3 text-center text-sm text-slate-300/90 italic bg-slate-900/60 border border-slate-700/80";
          cell.textContent = "Tiada rekod arkib minggu lepas lagi.";
          row.appendChild(cell);
          archiveTableBody.appendChild(row);
          return;
        }

        weeklyArchive.sort((a, b) => {
          const da = dayjs(a.weekStart, "YYYY-MM-DD");
          const db = dayjs(b.weekStart, "YYYY-MM-DD");
          return db.diff(da);
        });

        weeklyArchive.forEach((weekItem, idx) => {
          const row = document.createElement("tr");

          const storedDate = weekItem.weekStart;
          const ds = dayjs(storedDate, "YYYY-MM-DD");
          const dateLabel = ds.isValid()
            ? formatWeekRange(ds)
            : storedDate;

          const weekCol = document.createElement("td");
          weekCol.className = "px-3 py-2 text-xs sm:text-sm text-slate-100 border border-slate-700/80";
          weekCol.textContent = dateLabel;
          row.appendChild(weekCol);

          const countBookings = countAllBookings(weekItem.schedule);
          const totalSlots = DAY_KEYS.length * PERIODS.length;
          const usageText = `${countBookings} tempahan / ${totalSlots} slot`;

          const usageCol = document.createElement("td");
          usageCol.className = "px-3 py-2 text-xs sm:text-sm text-slate-200 border border-slate-700/80";
          usageCol.textContent = usageText;
          row.appendChild(usageCol);

          const metaCol = document.createElement("td");
          metaCol.className = "px-3 py-2 text-xs sm:text-[11px] text-slate-300/95 border border-slate-700/80";
          metaCol.textContent = weekItem.note || "â€”";
          row.appendChild(metaCol);

          const actionCol = document.createElement("td");
          actionCol.className = "px-3 py-2 text-xs sm:text-sm border border-slate-700/80";

          const viewBtn = document.createElement("button");
          viewBtn.className =
            "px-3 py-1 rounded-full bg-cyan-700/80 hover:bg-cyan-600 text-xs sm:text-sm text-white shadow hover:shadow-cyan-500/40 transition-all";
          viewBtn.textContent = "Lihat Jadual";

          viewBtn.addEventListener("click", () => {
            archiveViewIndex = idx;
            renderPreviewFromArchive();
          });

          actionCol.appendChild(viewBtn);
          row.appendChild(actionCol);

          archiveTableBody.appendChild(row);
        });
      }

      function countAllBookings(schedule) {
        if (!schedule || !schedule.assignments) return 0;
        let count = 0;
        for (const slotId in schedule.assignments) {
          const a = schedule.assignments[slotId];
          if (!a) continue;
          if (a.status === "tetap" || a.status === "tempahan" || a.status === "terkunci" || a.status === "penuh") {
            count++;
          }
        }
        return count;
      }

      function renderPreviewFromArchive() {
        if (archiveViewIndex < 0 || archiveViewIndex >= weeklyArchive.length) {
          archiveViewIndex = -1;
          updateWeekDisplay();
          renderMainTable();
          renderPrintTable();
          return;
        }

        const item = weeklyArchive[archiveViewIndex];
        if (!item || !item.schedule) {
          archiveViewIndex = -1;
          updateWeekDisplay();
          renderMainTable();
          renderPrintTable();
          return;
        }

        currentSchedule = item.schedule;
        if (item.weekStart) {
          const d = dayjs(item.weekStart, "YYYY-MM-DD");
          if (d.isValid()) {
            currentWeekStart = d;
          }
        }

        updateWeekDisplay();
        renderMainTable();
        renderPrintTable();
      }

      function updateAdminUI() {
        if (adminLoggedIn) {
          adminPanelEl.classList.remove("hidden");
          adminToggleBtn.textContent = "Mod Admin (ON)";
          adminToggleBtn.classList.remove("bg-slate-700");
          adminToggleBtn.classList.add("bg-amber-600", "hover:bg-amber-500", "shadow-amber-500/40");

          resetWeekBtn.disabled = false;
          manualRolloverBtn.disabled = false;
          exportCsvBtn.disabled = false;
          exportPrintBtn.disabled = false;
        } else {
          adminPanelEl.classList.add("hidden");
          adminToggleBtn.textContent = "Mod Admin";
          adminToggleBtn.classList.remove("bg-amber-600", "hover:bg-amber-500", "shadow-amber-500/40");
          adminToggleBtn.classList.add("bg-slate-700");

          resetWeekBtn.disabled = true;
          manualRolloverBtn.disabled = true;
          exportCsvBtn.disabled = true;
          exportPrintBtn.disabled = true;
        }

        renderMainTable();
        renderPrintTable();
      }

      function showBusyModal(slotId, currentStatus = "terkunci", currentReason = "") {
        if (!adminLoggedIn) return;

        selectedSlot = slotId;
        busyModalOpen = true;
        busyModal.classList.remove("hidden");

        const { dayKey, periodIndex } = parseSlotId(slotId);
        const dayName = DAYS[DAY_KEYS.indexOf(dayKey)] || dayKey.toUpperCase();
        const periodLabel = PERIODS[periodIndex];
        const timeLabel = PERIOD_TIMES[periodIndex] || "";

        const statusText = (currentStatus === "penuh")
          ? "Slot Penuh"
          : "Slot Terkunci";

        busyModalTitle.textContent = statusText;
        busySlotInfo.textContent = `${dayName} (${periodLabel}) ${timeLabel}`;
        busyReasonInput.value = currentReason;

        busyReasonLabel.textContent = (currentStatus === "penuh")
          ? "Sebab slot ini ditandakan PENUH (contoh: Peperiksaan, program besar, dsb.)"
          : "Sebab slot ini dikunci (contoh: penyelenggaraan, persediaan, dsb.)";

        busySaveBtn.textContent = "Simpan";
      }

      function closeBusyModal() {
        busyModalOpen = false;
        busyModal.classList.add("hidden");
        selectedSlot = null;
        busyReasonInput.value = "";
      }

      busyCancelBtn.addEventListener("click", () => {
        closeBusyModal();
      });

      busySaveBtn.addEventListener("click", async () => {
        if (!selectedSlot || !currentSchedule) return;

        const reason = busyReasonInput.value.trim();
        const { dayKey, periodIndex } = parseSlotId(selectedSlot);
        const slotId = selectedSlot;

        const existing = currentSchedule.assignments[slotId] || {};
        let desiredStatus = existing.status;
        if (existing.status === "terkunci") {
          desiredStatus = "penuh";
        } else if (existing.status === "penuh") {
          desiredStatus = "terkunci";
        } else {
          desiredStatus = "terkunci";
        }

        currentSchedule.assignments[slotId] = {
          status: desiredStatus,
          text: reason,
        };

        try {
          showLoading("Menyimpan status slot...");
          await persistScheduleToDB();
          showToast("Status slot berjaya dikemas kini.");
        } catch (err) {
          console.error("Error update busy slot:", err);
          showToast("Ralat ketika menyimpan status slot.", true);
        } finally {
          hideLoading();
          closeBusyModal();
          renderMainTable();
          renderPrintTable();
        }
      });

      busyModal.addEventListener("click", (e) => {
        if (e.target === busyModal) {
          closeBusyModal();
        }
      });

      function mapDocToSchedule(docData) {
        if (!docData || !docData.currentWeek) {
          return null;
        }
        const c = docData.currentWeek;
        const tmp = {
          weekStart: c.weekStart || dayjs().isoWeekday(1).format("YYYY-MM-DD"),
          assignments: {},
        };

        if (c.assignments) {
          for (const slotId in c.assignments) {
            const a = c.assignments[slotId];
            if (!a) continue;

            if (a === true || a === "1") {
              tmp.assignments[slotId] = {
                status: "tetap",
                text: "KELAS TETAP\n(Tidak ditulis butiran)",
              };
            } else if (typeof a === "string") {
              tmp.assignments[slotId] = {
                status: "tempahan",
                text: a,
              };
            } else if (typeof a === "object") {
              tmp.assignments[slotId] = {
                status: a.status || "tempahan",
                text: a.text || "",
              };
            }
          }
        }

        return tmp;
      }

      function mapDocToArchive(docData) {
        if (!docData || !docData.archive) {
          return [];
        }
        const arr = docData.archive || [];
        return arr.map((item) => {
          const w = item.weekStart || dayjs().isoWeekday(1).format("YYYY-MM-DD");
          const scheduleRaw = item.schedule || {};
          const mapped = {
            weekStart: w,
            schedule: {
              weekStart: w,
              assignments: {},
            },
            note: item.note || "",
          };
          if (scheduleRaw.assignments) {
            for (const slotId in scheduleRaw.assignments) {
              const a = scheduleRaw.assignments[slotId];
              if (!a) continue;
              if (a === true || a === "1") {
                mapped.schedule.assignments[slotId] = {
                  status: "tetap",
                  text: "KELAS TETAP\n(Tidak ditulis butiran)",
                };
              } else if (typeof a === "string") {
                mapped.schedule.assignments[slotId] = {
                  status: "tempahan",
                  text: a,
                };
              } else if (typeof a === "object") {
                mapped.schedule.assignments[slotId] = {
                  status: a.status || "tempahan",
                  text: a.text || "",
                };
              }
            }
          }
          mapped.weekStartDayjs = dayjs(w, "YYYY-MM-DD");
          return mapped;
        });
      }

      function fillDefaultIfMissing(schedule) {
        if (!schedule.assignments) {
          schedule.assignments = {};
        }
        DAY_KEYS.forEach((dayKey) => {
          PERIODS.forEach((p, idx) => {
            const slotId = getSlotId(dayKey, idx);
            if (!schedule.assignments[slotId]) {
              schedule.assignments[slotId] = {
                status: "kosong",
                text: "",
              };
            }
          });
        });
        return schedule;
      }

      function ensureDataVersion(docData) {
        if (!docData.meta) docData.meta = {};
        if (docData.meta.version !== DATA_VERSION) {
          docData.meta.version = DATA_VERSION;
        }
        return docData;
      }

      async function loadFromFirestore() {
        showLoading("Memuatkan jadual dari pelayan...");
        try {
          const snap = await getDoc(mainDocRef);
          if (!snap.exists()) {
            const defaultWeekStart = dayjs().isoWeekday(1).format("YYYY-MM-DD");
            const initialData = {
              meta: {
                createdAt: new Date().toISOString(),
                version: DATA_VERSION,
              },
              currentWeek: {
                weekStart: defaultWeekStart,
                assignments: {},
              },
              archive: [],
              lastRolloverDate: null,
              admin: {
                passwordHash: null,
              },
            };
            await setDoc(mainDocRef, initialData);
            currentWeekStart = dayjs(defaultWeekStart, "YYYY-MM-DD");
            currentSchedule = fillDefaultIfMissing({
              weekStart: defaultWeekStart,
              assignments: {},
            });
            weeklyArchive = [];
            isAdminPasswordSet = false;
            updateAdminPasswordUI();
            return;
          }

          let data = snap.data();
          data = ensureDataVersion(data);

          const schedule = mapDocToSchedule(data);
          if (schedule) {
            currentWeekStart = dayjs(schedule.weekStart, "YYYY-MM-DD");
            if (!currentWeekStart.isValid()) {
              currentWeekStart = dayjs().isoWeekday(1);
              schedule.weekStart = currentWeekStart.format("YYYY-MM-DD");
            }
            currentSchedule = fillDefaultIfMissing(schedule);
          } else {
            const defaultWeekStart = dayjs().isoWeekday(1);
            currentWeekStart = defaultWeekStart;
            currentSchedule = fillDefaultIfMissing({
              weekStart: defaultWeekStart.format("YYYY-MM-DD"),
              assignments: {},
            });
          }

          weeklyArchive = mapDocToArchive(data);
          isAdminPasswordSet = !!(data.admin && data.admin.passwordHash);
          updateAdminPasswordUI();

          const initialLastRolloverStr = data.lastRolloverDate || null;
          await checkWeeklyRollover(initialLastRolloverStr);
        } catch (err) {
          console.error("Ralat memuatkan data:", err);
          showToast("Ralat memuatkan data dari pelayan.", true);
        } finally {
          hideLoading();
          updateWeekDisplay();
          renderMainTable();
          renderArchiveTable();
          renderPrintTable();
        }
      }

      async function persistScheduleToDB(extraFields = {}) {
        if (!currentSchedule) return;

        const docSnap = await getDoc(mainDocRef);
        let existing = {};
        if (docSnap.exists()) {
          existing = docSnap.data();
        }
        existing = ensureDataVersion(existing);

        existing.currentWeek = {
          weekStart: currentWeekStart.format("YYYY-MM-DD"),
          assignments: currentSchedule.assignments,
        };

        if (!existing.archive) {
          existing.archive = [];
        }

        existing = {
          ...existing,
          ...extraFields,
        };

        await setDoc(mainDocRef, existing, { merge: true });
      }

      async function saveLastRolloverDateToDB(dateStr) {
        await updateDoc(mainDocRef, {
          lastRolloverDate: dateStr,
        });
      }

      // ==========================================
      //  FUNGSI AUTO ROLLOVER MINGGU BERASASKAN SABTU
      //  (TANPA PERLU BUKA PAGE PADA HARI SABTU)
      // ==========================================
      async function checkWeeklyRollover(initialLastRolloverStr) {
        const today = dayjs();

        // 1 = Isnin, ... 6 = Sabtu, 7 = Ahad
        const dow = today.isoWeekday();

        // Isnin minggu "sekarang"
        let targetWeekStart = today.isoWeekday(1);

        // Jika hari ini Sabtu (6) atau Ahad (7), kita anggap minggu tempahan
        // yang patut aktif ialah Isnin minggu DEPAN
        if (dow >= 6) {
          targetWeekStart = targetWeekStart.add(1, "week");
        }

        // Kalau currentWeekStart belum ada (first time), guna default
        if (!currentWeekStart) {
          currentWeekStart = getDefaultWeekStart();
        }

        // Bezakan berapa minggu jarak antara minggu dalam DB dengan minggu yang sepatutnya aktif
        const weeksDiff = targetWeekStart.diff(currentWeekStart, "week");

        // Kalau minggu dalam DB sudah sama / mendahului, tak perlu buat apa-apa
        if (weeksDiff <= 0) return;

        showLoading("Memulakan minggu baru...");

        // Ulang rollover ikut bilangan minggu yang tertinggal
        for (let i = 0; i < weeksDiff; i++) {
          await handleRollover(false); // ini akan tambah 7 hari pada currentWeekStart & simpan ke DB
        }

        // Rekod tarikh terakhir auto-rollover (pilihan, untuk rujukan)
        await saveLastRolloverDateToDB(today.format("YYYY-MM-DD"));

        hideLoading();
        showToast("Minggu baru telah dimulakan (auto berdasarkan hari Sabtu).");
      }

      async function handleRollover(confirmDialog = true) {
        if (!currentSchedule) return;

        if (confirmDialog) {
          const ok = window.confirm("Adakah anda pasti mahu memulakan minggu baru dan arkib minggu ini?");
          if (!ok) return;
        }

        const archiveItem = {
          weekStart: currentWeekStart.format("YYYY-MM-DD"),
          schedule: {
            weekStart: currentWeekStart.format("YYYY-MM-DD"),
            assignments: currentSchedule.assignments,
          },
          note: "Auto arkib minggu lalu...",
        };

        weeklyArchive.push(archiveItem);

        currentWeekStart = currentWeekStart.add(1, "week");

        currentSchedule = fillDefaultIfMissing({
          weekStart: currentWeekStart.format("YYYY-MM-DD"),
          assignments: {},
        });

        await persistScheduleToDB({
          archive: weeklyArchive.map((item) => ({
            weekStart: item.weekStart,
            schedule: item.schedule,
            note: item.note || "",
          })),
        });

        archiveViewIndex = -1;
        updateWeekDisplay();
        renderMainTable();
        renderArchiveTable();
        renderPrintTable();

        if (confirmDialog) {
          showToast("Minggu baru telah dimulakan.");
        }
      }

      function renderPrintTable() {
        clearTableBody(printBody);

        const data = getDisplayedScheduleData();
        if (!data) return;

        const weekStart = (archiveViewIndex === -1)
          ? currentWeekStart || getDefaultWeekStart()
          : (weeklyArchive[archiveViewIndex]?.weekStartDayjs || currentWeekStart || getDefaultWeekStart());

        if (weekStart) {
          const rangeText = formatWeekRange(weekStart);
          printWeekText.textContent = `MINGGU: ${rangeText}`;
        } else {
          printWeekText.textContent = "MINGGU: -";
        }

        const now = dayjs();
        printDateTime.textContent = `Dicetak pada: ${now.format("DD/MM/YYYY [pukul] HH:mm")}`;

        DAY_KEYS.forEach((dayKey, dayIndex) => {
          const row = document.createElement("tr");

          const dayCell = document.createElement("td");
          dayCell.className = "border border-slate-700 px-2 py-1 text-xs font-semibold text-slate-100 align-middle print:text-[10px]";
          dayCell.textContent = DAYS[dayIndex];
          row.appendChild(dayCell);

          PERIODS.forEach((p, pIndex) => {
            const slotId = getSlotId(dayKey, pIndex);
            const assign = data.assignments[slotId] || { status: "kosong", text: "" };

            const cell = document.createElement("td");
            cell.className = "border border-slate-700 px-1 py-1 text-[10px] text-slate-100 align-top print:text-[9px]";

            let cellContent = "";

            if (!assign || assign.status === "kosong") {
              cellContent = "";
            } else if (assign.status === "terkunci" || assign.status === "penuh") {
              const reason = (assign.text || "").trim();
              const label = assign.status === "penuh" ? "[PENUH]" : "[TERKUNCI]";
              cellContent = `${label} ${reason || ""}`;
            } else {
              const detail = parseBookingText(assign.text);
              if (detail) {
                cellContent = `${detail.tahun}-${detail.kelas}\n${detail.mataPelajaran}\n${detail.namaGuru}`;
              } else {
                cellContent = assign.text || "";
              }
            }

            cell.textContent = cellContent;
            row.appendChild(cell);
          });

          printBody.appendChild(row);
        });
      }

      async function resetCurrentWeek() {
        if (!adminLoggedIn || !currentSchedule) return;
        const ok = window.confirm("Anda pasti mahu RESET semua tempahan minggu INI sahaja?");
        if (!ok) return;

        DAY_KEYS.forEach((dayKey) => {
          PERIODS.forEach((p, idx) => {
            const slotId = getSlotId(dayKey, idx);
            const existing = currentSchedule.assignments[slotId];
            if (existing && existing.status === "tetap") {
              return;
            }
            currentSchedule.assignments[slotId] = {
              status: "kosong",
              text: "",
            };
          });
        });

        await persistScheduleToDB();
        renderMainTable();
        renderPrintTable();
        showToast("Minggu semasa telah direset (kecuali jadual tetap).");
      }

      function handleAdminCellClick(slotId) {
        if (!adminLoggedIn || !currentSchedule) return;

        const assign = currentSchedule.assignments[slotId] || { status: "kosong", text: "" };

        const { dayKey, periodIndex } = parseSlotId(slotId);
        const dayName = DAYS[DAY_KEYS.indexOf(dayKey)] || dayKey.toUpperCase();
        const periodLabel = PERIODS[periodIndex];
        const timeLabel = PERIOD_TIMES[periodIndex] || "";

        let promptMsg = `Mengedit tempahan untuk ${dayName}, ${periodLabel} (${timeLabel}).\n\n`;
        promptMsg += "Format cadangan:\n";
        promptMsg += "TAHUN 5 - AMANAH\n";
        promptMsg += "MATEMATIK\n";
        promptMsg += "Guru: Cikgu Sufian\n\n";
        promptMsg += "Kosongkan untuk buang tempahan.\n\n";
        promptMsg += "Masukkan butiran baharu:";

        const newText = window.prompt(promptMsg, assign.text || "");
        if (newText === null) return;

        const trimmed = newText.trim();
        if (!trimmed) {
          if (assign.status === "tetap") {
            showToast("Slot ini jadual TETAP, tidak boleh dikosongkan sepenuhnya.", true);
            return;
          }
          currentSchedule.assignments[slotId] = {
            status: "kosong",
            text: "",
          };
        } else {
          const isPermanent = window.confirm("Adakah tempahan ini JADUAL TETAP (klik OK) atau TEMPORARI (klik Batal)?");
          currentSchedule.assignments[slotId] = {
            status: isPermanent ? "tetap" : "tempahan",
            text: trimmed,
          };
        }

        persistScheduleToDB()
          .then(() => {
            renderMainTable();
            renderPrintTable();
            showToast("Slot berjaya dikemas kini.");
          })
          .catch((err) => {
            console.error("Error update slot:", err);
            showToast("Ralat ketika menyimpan slot.", true);
          });
      }

      function setupAdminPassword(data) {
        if (!data.admin) data.admin = {};
        isAdminPasswordSet = !!data.admin.passwordHash;
        updateAdminPasswordUI();
      }

      function updateAdminPasswordUI() {
        if (!isAdminPasswordSet) {
          setAdminPasswordDiv.classList.remove("hidden");
        } else {
          setAdminPasswordDiv.classList.add("hidden");
        }
      }

      function simpleHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          const chr = str.charCodeAt(i);
          hash = (hash << 5) - hash + chr;
          hash |= 0;
        }
        return hash.toString();
      }

      async function checkAdminPassword(password) {
        const snap = await getDoc(mainDocRef);
        if (!snap.exists()) return false;
        const data = snap.data();
        if (!data.admin || !data.admin.passwordHash) return false;

        const hashPw = simpleHash(password);
        return data.admin.passwordHash === hashPw;
      }

      async function setNewAdminPassword(password) {
        const hashPw = simpleHash(password);
        await updateDoc(mainDocRef, {
          admin: { passwordHash: hashPw },
        });
        isAdminPasswordSet = true;
        updateAdminPasswordUI();
      }

      adminToggleBtn.addEventListener("click", async () => {
        if (adminLoggedIn) {
          const ok = window.confirm("Log keluar daripada mod admin?");
          if (!ok) return;
          adminLoggedIn = false;
          localStorage.setItem("jadual_makmal_admin_login_2025", "false");
          updateAdminUI();
          showToast("Anda telah log keluar dari mod admin.");
          return;
        }

        const pwd = adminPasswordInput.value.trim();
        if (!pwd) {
          showToast("Sila masukkan kata laluan admin.", true);
          return;
        }

        showLoading("Memeriksa kata laluan admin...");
        try {
          const success = await checkAdminPassword(pwd);
          if (!success) {
            showToast("Kata laluan admin salah.", true);
          } else {
            adminLoggedIn = true;
            localStorage.setItem("jadual_makmal_admin_login_2025", "true");
            updateAdminUI();
            showToast("Mod admin diaktifkan.");
          }
        } catch (err) {
          console.error("Error login admin:", err);
          showToast("Ralat semasa login admin.", true);
        } finally {
          hideLoading();
        }
      });

      setAdminPasswordBtn.addEventListener("click", async () => {
        const newPwd = newAdminPasswordInput.value.trim();
        if (!newPwd) {
          showToast("Sila masukkan kata laluan admin baharu.", true);
          return;
        }

        const cfm = window.confirm("Tetapkan kata laluan admin baharu?");
        if (!cfm) return;

        try {
          showLoading("Menyimpan kata laluan admin...");
          await setNewAdminPassword(newPwd);
          showToast("Kata laluan admin telah ditetapkan.");
        } catch (err) {
          console.error("Error set admin password:", err);
          showToast("Ralat ketika menetapkan kata laluan admin.", true);
        } finally {
          hideLoading();
        }
      });

      adminLogoutBtn.addEventListener("click", () => {
        if (!adminLoggedIn) return;
        const ok = window.confirm("Log keluar daripada mod admin?");
        if (!ok) return;
        adminLoggedIn = false;
        localStorage.setItem("jadual_makmal_admin_login_2025", "false");
        updateAdminUI();
        showToast("Anda telah log keluar dari mod admin.");
      });

      resetWeekBtn.addEventListener("click", () => {
        resetCurrentWeek();
      });

      manualRolloverBtn.addEventListener("click", async () => {
        await handleRollover(true);
      });

      exportCsvBtn.addEventListener("click", () => {
        exportCSV();
      });

      exportPrintBtn.addEventListener("click", () => {
        window.print();
      });

      prevWeekBtn.addEventListener("click", () => {
        if (archiveViewIndex === -1) {
          const idx = weeklyArchive.findIndex((item) =>
            item.weekStartDayjs.isSame(currentWeekStart, "day")
          );
          if (idx >= 0) {
            if (idx + 1 < weeklyArchive.length) {
              archiveViewIndex = idx + 1;
              renderPreviewFromArchive();
            } else {
              showToast("Tiada rekod arkib lebih lama.");
            }
          } else {
            if (weeklyArchive.length > 0) {
              archiveViewIndex = weeklyArchive.length - 1;
              renderPreviewFromArchive();
            } else {
              showToast("Tiada rekod arkib.");
            }
          }
        } else {
          if (archiveViewIndex + 1 < weeklyArchive.length) {
            archiveViewIndex++;
            renderPreviewFromArchive();
          } else {
            showToast("Tiada rekod arkib lebih lama.");
          }
        }
      });

      nextWeekBtn.addEventListener("click", () => {
        if (archiveViewIndex === -1) {
          showToast("Anda sudah di minggu semasa.");
          return;
        }

        if (archiveViewIndex === 0) {
          archiveViewIndex = -1;
          updateWeekDisplay();
          renderMainTable();
          renderPrintTable();
        } else {
          archiveViewIndex--;
          renderPreviewFromArchive();
        }
      });

      currentWeekBtn.addEventListener("click", () => {
        archiveViewIndex = -1;
        updateWeekDisplay();
        renderMainTable();
        renderPrintTable();
      });

      async function init() {
        showLoading("Memulakan aplikasi jadual makmal...");
        try {
          await loadFromFirestore();
        } catch (err) {
          console.error("Error init:", err);
          showToast("Ralat semasa memulakan aplikasi.", true);
        } finally {
          hideLoading();
        }

        onSnapshot(mainDocRef, (snap) => {
          if (!snap.exists()) return;
          const data = snap.data();
          const schedule = mapDocToSchedule(data);
          if (schedule) {
            currentWeekStart = dayjs(schedule.weekStart, "YYYY-MM-DD");
            if (!currentWeekStart.isValid()) {
              currentWeekStart = dayjs().isoWeekday(1);
              schedule.weekStart = currentWeekStart.format("YYYY-MM-DD");
            }
            currentSchedule = fillDefaultIfMissing(schedule);
          }
          weeklyArchive = mapDocToArchive(data);
          updateWeekDisplay();
          renderMainTable();
          renderArchiveTable();
          renderPrintTable();
        });
      }

      init();
    });
  </script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
    }

    @media print {
      body {
        font-size: 10px;
        color: #000;
      }
      #app-container {
        box-shadow: none !important;
      }
      .no-print {
        display: none !important;
      }
      .print-only {
        display: block !important;
      }
      .print-table {
        width: 100%;
        border-collapse: collapse;
      }
      .print-table th,
      .print-table td {
        border: 1px solid #000;
        padding: 2px 4px;
      }
      #print-header {
        display: block !important;
      }
    }

    .print-only {
      display: none;
    }

    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    .scrollbar-thin::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.7);
    }

    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: rgba(148, 163, 184, 0.8);
      border-radius: 999px;
    }

    .print-table th,
    .print-table td {
      word-wrap: break-word;
      word-break: break-word;
    }

    .print-table select {
      font-size: 10px;
    }
  </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
  <div id="loading-overlay" class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="flex flex-col items-center gap-4">
      <div class="w-12 h-12 border-4 border-cyan-400 border-t-transparent rounded-full animate-spin"></div>
      <div id="loading-message" class="text-sm sm:text-base text-cyan-100 font-medium">Sila tunggu...</div>
    </div>
  </div>

  <div id="toast" class="fixed top-4 inset-x-4 sm:right-4 sm:left-auto z-50 hidden">
    <div class="px-4 py-3 rounded-lg shadow-lg text-sm text-white flex items-center justify-between gap-3">
      <span id="toast-text">Ini mesej toast</span>
      <button onclick="this.parentElement.parentElement.classList.add('hidden')" class="text-xs font-semibold uppercase tracking-wide">Tutup</button>
    </div>
  </div>

  <div id="app-container" class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-6">
    <div id="print-header" class="print-only mb-4 text-center">
      <h1 class="font-bold text-lg uppercase">JADUAL TEMPAHAN MAKMAL KOMPUTER SK SRI AMAN 2025</h1>
      <div id="print-week-text" class="mt-1 text-sm"></div>
      <div id="print-date-time" class="mt-1 text-xs text-slate-700"></div>
    </div>

    <div class="no-print mb-4 sm:mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
      <div>
        <h1 class="text-xl sm:text-2xl font-extrabold text-cyan-300 tracking-tight">
          JADUAL TEMPAHAN MAKMAL KOMPUTER
        </h1>
        <p class="text-xs sm:text-sm text-slate-300 mt-0.5">
          SK Sri Aman &middot; Sesi 2025
        </p>
      </div>

      <div class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center">
        <div class="inline-flex items-center gap-2 rounded-full bg-slate-800/80 border border-slate-600 px-3 py-1.5">
          <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
          <span class="text-xs text-slate-100">Status: <span class="font-semibold text-green-300">Dalam Talian</span></span>
        </div>
      </div>
    </div>

    <div class="no-print mb-4">
      <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <button id="prev-week-btn" class="px-3 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700 text-xs sm:text-sm border border-slate-500 flex items-center gap-1">
            <span>&larr;</span>
            <span>Minggu Sebelum</span>
          </button>

          <button id="current-week-btn" class="px-3 py-1.5 rounded-full bg-cyan-700 hover:bg-cyan-600 text-xs sm:text-sm border border-cyan-400 text-white font-semibold shadow shadow-cyan-500/40">
            Minggu Semasa
          </button>

          <button id="next-week-btn" class="px-3 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700 text-xs sm:text-sm border border-slate-500 flex items-center gap-1">
            <span>Minggu Seterusnya</span>
            <span>&rarr;</span>
          </button>
        </div>

        <div id="week-display" class="px-4 py-2 rounded-xl bg-slate-900/90 border border-cyan-500/60 text-cyan-200 text-xs sm:text-sm font-semibold tracking-wide shadow shadow-cyan-500/30">
          TARIKH: -
        </div>
      </div>
    </div>

    <div class="no-print mb-4 sm:mb-6">
      <div class="flex flex-wrap items-center gap-2 text-[11px] sm:text-xs text-slate-200">
        <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-green-900/70 border border-emerald-400/80">
          <span class="w-1.5 h-1.5 rounded-full bg-emerald-300"></span>
          <span>Jadual Tetap</span>
        </div>
        <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-cyan-900/70 border border-cyan-400/80">
          <span class="w-1.5 h-1.5 rounded-full bg-cyan-300"></span>
          <span>Tempahan Guru</span>
        </div>
        <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-amber-900/70 border border-amber-400/80">
          <span class="w-1.5 h-1.5 rounded-full bg-amber-300"></span>
          <span>Slot Terkunci (Admin)</span>
        </div>
        <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-red-900/70 border border-red-400/80">
          <span class="w-1.5 h-1.5 rounded-full bg-red-300"></span>
          <span>Slot Penuh / Tidak Boleh Ditempah</span>
        </div>
      </div>
    </div>

    <div class="no-print mb-4 sm:mb-6">
      <div class="rounded-2xl bg-slate-900/90 border border-slate-700/80 shadow-2xl shadow-cyan-900/60 overflow-hidden">
        <div class="bg-slate-900/95 border-b border-slate-700/80 px-3 sm:px-4 py-2 flex items-center justify-between gap-2">
          <div class="flex items-center gap-2 text-xs sm:text-sm text-slate-200">
            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-cyan-700 text-white text-xs font-bold">i</span>
            <span>Jadual Mingguan Makmal Komputer</span>
          </div>
        </div>

        <div class="overflow-auto scrollbar-thin max-h-[480px] sm:max-h-[520px]">
          <table class="w-full border-collapse text-[11px] sm:text-sm">
            <thead class="bg-slate-900/95 sticky top-0 z-10">
              <tr>
                <th class="sticky left-0 bg-slate-950/95 text-slate-200 border border-slate-700/80 px-2 py-2 text-xs sm:text-sm align-middle">
                  Hari / Masa
                </th>
                ${PERIOD_TIMES.map((t, i) => `
                <th class="border border-slate-700/80 px-2 py-2 text-[10px] sm:text-xs text-slate-200">
                  ${PERIODS[i]}<br /><span class="text-[10px] text-slate-400">${t}</span>
                </th>`).join("")}
              </tr>
            </thead>
            <tbody id="main-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="no-print grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-5 mb-6">
      <div class="lg:col-span-2 rounded-2xl bg-slate-900/90 border border-slate-700/80 shadow-xl">
        <div class="px-4 py-2 border-b border-slate-700/80 flex items-center justify-between">
          <div class="flex items-center gap-2 text-xs sm:text-sm text-slate-200">
            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-violet-700 text-white text-xs font-bold">A</span>
            <span>Arkib Minggu Lepas</span>
          </div>
        </div>
        <div class="overflow-auto scrollbar-thin max-h-60">
          <table class="w-full border-collapse text-[11px] sm:text-xs">
            <thead class="bg-slate-950/95">
              <tr>
                <th class="border border-slate-700/80 px-2 py-1 text-left">Minggu</th>
                <th class="border border-slate-700/80 px-2 py-1 text-left">Statistik Tempahan</th>
                <th class="border border-slate-700/80 px-2 py-1 text-left">Catatan</th>
                <th class="border border-slate-700/80 px-2 py-1 text-center">Tindakan</th>
              </tr>
            </thead>
            <tbody id="archive-table-body"></tbody>
          </table>
        </div>
      </div>

      <div class="rounded-2xl bg-slate-900/90 border border-slate-700/80 shadow-xl no-print">
        <div class="px-4 py-2 border-b border-slate-700/80 flex items-center justify-between">
          <div class="flex items-center gap-2 text-xs sm:text-sm text-slate-200">
            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-amber-600 text-white text-xs font-bold">âš™</span>
            <span>Panel Admin</span>
          </div>
          <button id="admin-toggle-btn" class="px-3 py-1.5 rounded-full bg-slate-700 text-xs sm:text-xs text-slate-100 border border-slate-500">
            Mod Admin
          </button>
        </div>

        <div class="px-4 py-3 space-y-3">
          <div class="space-y-2">
            <label class="block text-[11px] text-slate-300">Kata Laluan Admin</label>
            <input id="admin-password" type="password" class="w-full px-2 py-1.5 rounded-lg bg-slate-800 border border-slate-600 text-xs sm:text-sm text-slate-100" placeholder="Masukkan kata laluan admin" />
          </div>

          <div id="set-admin-password" class="space-y-2 hidden">
            <div class="text-[11px] text-amber-200">
              Kata laluan admin belum ditetapkan. Sila tetapkan kata laluan pertama kali:
            </div>
            <input id="new-admin-password" type="password" class="w-full px-2 py-1.5 rounded-lg bg-slate-800 border border-slate-600 text-xs sm:text-sm text-slate-100" placeholder="Kata laluan baharu admin" />
            <button id="set-admin-password-btn" class="w-full px-3 py-1.5 rounded-lg bg-amber-600 hover:bg-amber-500 text-xs sm:text-sm text-white font-semibold">
              Tetapkan Kata Laluan
            </button>
          </div>

          <div id="admin-panel" class="space-y-3 hidden">
            <div class="border-t border-slate-700/80 pt-3 mt-2 space-y-2">
              <div class="text-[11px] text-slate-300">Tindakan Mingguan</div>
              <div class="flex flex-col sm:flex-row gap-2">
                <button id="reset-week-btn" class="flex-1 px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs sm:text-xs border border-slate-500 text-slate-100 disabled:opacity-40 disabled:cursor-not-allowed">
                  Reset Minggu Ini
                </button>
                <button id="manual-rollover-btn" class="flex-1 px-3 py-1.5 rounded-lg bg-violet-700 hover:bg-violet-600 text-xs sm:text-xs border border-violet-400 text-white disabled:opacity-40 disabled:cursor-not-allowed">
                  Mula Minggu Baharu
                </button>
              </div>
            </div>

            <div class="border-t border-slate-700/80 pt-3 mt-2 space-y-2">
              <div class="text-[11px] text-slate-300">Eksport & Cetakan</div>
              <div class="flex flex-col sm:flex-row gap-2">
                <button id="export-csv-btn" class="flex-1 px-3 py-1.5 rounded-lg bg-cyan-700 hover:bg-cyan-600 text-xs sm:text-xs border border-cyan-400 text-white disabled:opacity-40 disabled:cursor-not-allowed">
                  Eksport CSV
                </button>
                <button id="export-print-btn" class="flex-1 px-3 py-1.5 rounded-lg bg-emerald-700 hover:bg-emerald-600 text-xs sm:text-xs border border-emerald-400 text-white disabled:opacity-40 disabled:cursor-not-allowed">
                  Cetak Jadual
                </button>
              </div>
            </div>

            <div class="border-t border-slate-700/80 pt-3 mt-2">
              <button id="admin-logout-btn" class="w-full px-3 py-1.5 rounded-lg bg-red-700 hover:bg-red-600 text-xs sm:text-xs border border-red-400 text-white">
                Log Keluar Admin
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="print-only">
      <table id="print-table" class="print-table text-[10px] border border-slate-700">
        <thead>
          <tr>
            <th class="border border-slate-700 px-2 py-1 text-left align-middle">Hari / Masa</th>
            ${PERIOD_TIMES.map((t, i) => `
            <th class="border border-slate-700 px-2 py-1 text-left align-middle">
              ${PERIODS[i]}<br /><span class="text-[10px] text-slate-700">${t}</span>
            </th>`).join("")}
          </tr>
        </thead>
        <tbody id="print-table-body"></tbody>
      </table>
    </div>
  </div>

  <div id="busy-modal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm flex items-center justify-center z-40 hidden">
    <div class="bg-slate-900/95 border border-slate-600 rounded-2xl w-full max-w-md mx-3 shadow-2xl shadow-red-900/60">
      <div class="px-4 py-3 border-b border-slate-700 flex items-center justify-between">
        <div>
          <h2 id="busy-modal-title" class="text-sm sm:text-base font-semibold text-slate-100">Tetapan Slot</h2>
          <p id="busy-slot-info" class="text-[11px] sm:text-xs text-slate-300 mt-0.5">
            -
          </p>
        </div>
        <button id="busy-close-btn" class="text-slate-400 hover:text-slate-200 text-lg leading-none" onclick="document.getElementById('busy-modal').classList.add('hidden')">
          Ã—
        </button>
      </div>
      <div class="px-4 py-3 space-y-2">
        <label id="busy-reason-label" class="block text-[11px] text-slate-300">
          Sebab slot dikunci
        </label>
        <textarea id="busy-reason" rows="3" class="w-full px-2 py-1.5 rounded-lg bg-slate-800 border border-slate-600 text-xs sm:text-sm text-slate-100" placeholder="Contoh: Peperiksaan, penyelenggaraan, program sekolah, dsb."></textarea>
      </div>
      <div class="px-4 py-3 border-t border-slate-700 flex items-center justify-end gap-2">
        <button id="busy-cancel-btn" class="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-xs sm:text-xs text-slate-100">
          Batal
        </button>
        <button id="busy-save-btn" class="px-3 py-1.5 rounded-lg bg-red-700 hover:bg-red-600 text-xs sm:text-xs text-white">
          Simpan
        </button>
      </div>
    </div>
  </div>
</body>
</html>
